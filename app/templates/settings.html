<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Network Settings</title>

<style>
body {
  margin: 0;
  background: #0f172a;
  color: #e5e7eb;
  font-family: system-ui, -apple-system, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

.card {
  width: 640px;
  background: #020617;
  border-radius: 18px;
  padding: 32px;
  box-shadow: 0 30px 60px rgba(0,0,0,.6);
}

h2 {
  margin: 0 0 24px 0;
  text-align: center;
  font-weight: 600;
}

.section {
  margin-bottom: 28px;
}

.section-title {
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #38bdf8;
  margin-bottom: 14px;
}

.field {
  margin-bottom: 16px;
}

.row {
  display: flex;
  gap: 12px;
}

.field label {
  display: block;
  font-size: 13px;
  color: #94a3b8;
  margin-bottom: 6px;
}

.field input,
.field select {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #1e293b;
  background: #0b1220;
  color: #e5e7eb;
  font-size: 14px;
}

.field input:focus,
.field select:focus {
  outline: none;
  border-color: #38bdf8;
}

.status {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  margin-top: 8px;
}

.status.connected {
  background: #052e16;
  color: #22c55e;
}

.status.disconnected {
  background: #450a0a;
  color: #ef4444;
}

.actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

button {
  flex: 1;
  padding: 14px;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
  border: none;
}

.btn-primary {
  background: #38bdf8;
  color: #020617;
  font-weight: 600;
}

.btn-primary:disabled {
  opacity: .6;
  cursor: not-allowed;
}

.btn-secondary {
  background: transparent;
  border: 1px solid #1e293b;
  color: #94a3b8;
}

.loading {
  text-align: center;
  font-size: 13px;
  margin-top: 10px;
  color: #38bdf8;
}
</style>
</head>

<body>

<div class="card">
  <h2>Network Settings</h2>

  <!-- Network Section -->
  <div class="section">
    <div class="section-title">Connection Type</div>

    <div class="field">
      <label>Network Type</label>
      <select id="networkType">
        <option value="ethernet">Ethernet (Wired)</option>
        <option value="wifi">Wi-Fi (Wireless)</option>
      </select>
      <div id="connectionStatus" class="status disconnected">
        Checking...
      </div>
    </div>

    <div id="wifiFields">
      <div class="field">
        <label>Wi-Fi SSID</label>
        <input id="wifiSsid" placeholder="Factory_WiFi">
      </div>

      <div class="field">
        <label>Wi-Fi Password</label>
        <input id="wifiPassword" type="password" placeholder="••••••••">
      </div>
    </div>
  </div>

  <!-- IP Section -->
  <div class="section">
    <div class="section-title">IP Configuration</div>

    <div class="field">
      <label>IP Assignment</label>
      <select id="ipMode">
        <option value="dhcp">Automatic (DHCP)</option>
        <option value="static">Manual (Static)</option>
      </select>
    </div>

    <div id="staticFields">
      <div class="row">
        <div class="field">
          <label>IP Address (CIDR)</label>
          <input id="piIp" placeholder="192.168.1.50/24">
        </div>
        <div class="field">
          <label>Gateway</label>
          <input id="gateway" placeholder="192.168.1.1">
        </div>
      </div>

      <div class="field">
        <label>DNS Server</label>
        <input id="dns" placeholder="8.8.8.8">
      </div>
    </div>
  </div>

  <!-- Target Section -->
  <div class="section">
    <div class="section-title">Target Device</div>
    <div class="field">
      <label>Target URL</label>
      <input id="targetUrl" placeholder="http://192.168.1.10">
    </div>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn-primary" id="applyBtn">Apply Settings</button>
    <button class="btn-secondary" id="cancelBtn">Cancel</button>
  </div>

  <div id="loadingText" class="loading" style="display:none">
    Applying settings...
  </div>
</div>

<script>
const networkType = document.getElementById("networkType");
const ipMode = document.getElementById("ipMode");
const wifiFields = document.getElementById("wifiFields");
const staticFields = document.getElementById("staticFields");
const applyBtn = document.getElementById("applyBtn");
const cancelBtn = document.getElementById("cancelBtn");
const loadingText = document.getElementById("loadingText");
const connectionStatus = document.getElementById("connectionStatus");

function updateVisibility() {
  wifiFields.style.display =
    networkType.value === "wifi" ? "block" : "none";

  staticFields.style.display =
    ipMode.value === "static" ? "block" : "none";
}

async function loadSettings() {
  try {
    const res = await fetch("/api/config");
    const cfg = await res.json();

    networkType.value = cfg.network_type || "ethernet";
    ipMode.value = cfg.ip_mode || "dhcp";

    document.getElementById("piIp").value = cfg.pi_ip || "";
    document.getElementById("gateway").value = cfg.gateway || "";
    document.getElementById("dns").value = cfg.dns || "";
    document.getElementById("wifiSsid").value = cfg.wifi_ssid || "";
    document.getElementById("wifiPassword").value = cfg.wifi_password || "";
    document.getElementById("targetUrl").value = cfg.target_url || "";

    updateVisibility();
  } catch (err) {
    alert("Failed to load settings.");
  }
}

async function loadStatus() {
  try {
    const res = await fetch("/api/network/status");
    const data = await res.json();

    if (data.connected) {
      connectionStatus.textContent =
        "Connected (" + (data.interface || "") + ")";
      connectionStatus.className = "status connected";
    } else {
      connectionStatus.textContent = "Disconnected";
      connectionStatus.className = "status disconnected";
    }
  } catch {
    connectionStatus.textContent = "Unknown";
  }
}

async function applySettings() {
  const cfg = {
    network_type: networkType.value,
    ip_mode: ipMode.value,
    pi_ip: document.getElementById("piIp").value,
    gateway: document.getElementById("gateway").value,
    dns: document.getElementById("dns").value,
    wifi_ssid: document.getElementById("wifiSsid").value,
    wifi_password: document.getElementById("wifiPassword").value,
    target_url: document.getElementById("targetUrl").value
  };

  try {
    applyBtn.disabled = true;
    loadingText.style.display = "block";

    await fetch("/api/config", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(cfg)
    });

    await fetch("/api/network/apply", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(cfg)
    });

    alert("Network settings applied.");
    window.location.href = "/";
  } catch (err) {
    alert("Failed to apply settings.");
  } finally {
    applyBtn.disabled = false;
    loadingText.style.display = "none";
  }
}

cancelBtn.addEventListener("click", () => {
  window.location.href = "/";
});

networkType.addEventListener("change", updateVisibility);
ipMode.addEventListener("change", updateVisibility);
applyBtn.addEventListener("click", applySettings);

updateVisibility();
loadSettings();
loadStatus();
</script>

</body>
</html>